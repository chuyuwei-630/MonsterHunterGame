class MapSystem {
private:
    int size;
    vector<vector<string>> grid;
    map<string, Diamond*> diamondMap;

    Diamond* getRandomDiamond() {
        int r = rand() % 6;
        switch (r) {
            case 0: return new HealDiamond();
            case 1: return new TrapDiamond();
            case 2: return new ExpDiamond();
            case 3: return new GoldDiamond();
            case 4: return new EmptyDiamond();
            case 5: return new LevelUpDiamond();
        }
        return new EmptyDiamond();
    }

public:
    void generateMap() {
        // éš¨æ©Ÿæ±ºå®šåœ°åœ–å¤§å°ï¼ˆ3~7ï¼‰
        size = 3 + rand() % 5;
        grid = vector<vector<string>>(size, vector<string>(size, "[ ]"));
        diamondMap.clear();

        // æ”¾ç½® 5 é¡†é‘½çŸ³ï¼ˆæˆ–æ ¹æ“šåœ°åœ–å¤§å°èª¿æ•´æ•¸é‡ï¼‰
        int diamondCount = min(5, size * size / 2);

        for (int i = 0; i < diamondCount; i++) {
            int x, y;
            do {
                x = rand() % size;
                y = rand() % size;
            } while (grid[x][y] != "[ ]");

            grid[x][y] = "[ğŸ’]";
            string key = to_string(x) + "," + to_string(y);
            diamondMap[key] = getRandomDiamond();
        }
    }

    void displayMap() {
        cout << "ğŸ—º åœ°åœ–å°ºå¯¸ï¼š" << size << " x " << size << endl;
        for (int i = 0; i < size; i++) {
            for (int j = 0; j < size; j++)
                cout << grid[i][j] << " ";
            cout << endl;
        }
    }

    int getSize() const {
        return size;
    }

    bool chooseDiamond(Player &player, int x, int y) {
        string key = to_string(x) + "," + to_string(y);
        if (diamondMap.find(key) != diamondMap.end()) {
            Diamond* d = diamondMap[key];
            cout << "ğŸ¯ ä½ é¸æ“‡äº†ï¼š" << d->name << endl;
            d->applyEffect(player);
            delete d;
            diamondMap.erase(key);
            grid[x][y] = "[âœ“]";
            return true;
        } else {
            cout << "âŒ æ­¤è™•æ²’æœ‰é‘½çŸ³æˆ–å·²è¢«é¸å–ï¼" << endl;
            return false;
        }
    }
};
