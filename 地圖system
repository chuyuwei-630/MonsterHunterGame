class MapSystem {
private:
    int size;
    vector<vector<string>> grid;
    map<string, Diamond*> diamondMap;

    Diamond* getRandomDiamond() {
        int r = rand() % 6;
        switch (r) {
            case 0: return new HealDiamond();
            case 1: return new TrapDiamond();
            case 2: return new ExpDiamond();
            case 3: return new GoldDiamond();
            case 4: return new EmptyDiamond();
            case 5: return new LevelUpDiamond();
        }
        return new EmptyDiamond();
    }

public:
    void generateMap() {
        // 隨機決定地圖大小（3~7）
        size = 3 + rand() % 5;
        grid = vector<vector<string>>(size, vector<string>(size, "[ ]"));
        diamondMap.clear();

        // 放置 5 顆鑽石（或根據地圖大小調整數量）
        int diamondCount = min(5, size * size / 2);

        for (int i = 0; i < diamondCount; i++) {
            int x, y;
            do {
                x = rand() % size;
                y = rand() % size;
            } while (grid[x][y] != "[ ]");

            grid[x][y] = "[💎]";
            string key = to_string(x) + "," + to_string(y);
            diamondMap[key] = getRandomDiamond();
        }
    }

    void displayMap() {
        cout << "🗺 地圖尺寸：" << size << " x " << size << endl;
        for (int i = 0; i < size; i++) {
            for (int j = 0; j < size; j++)
                cout << grid[i][j] << " ";
            cout << endl;
        }
    }

    int getSize() const {
        return size;
    }

    bool chooseDiamond(Player &player, int x, int y) {
        string key = to_string(x) + "," + to_string(y);
        if (diamondMap.find(key) != diamondMap.end()) {
            Diamond* d = diamondMap[key];
            cout << "🎯 你選擇了：" << d->name << endl;
            d->applyEffect(player);
            delete d;
            diamondMap.erase(key);
            grid[x][y] = "[✓]";
            return true;
        } else {
            cout << "❌ 此處沒有鑽石或已被選取！" << endl;
            return false;
        }
    }
};
